import os
import json
import sys

def extract_regkey_opened(report_path):
    total_regkey_opened = 0
    regkey_opened = []
    try:
        with open(report_path, 'r') as report_file:
            report_data = json.load(report_file)
            target_filename = report_data["target"]["file"]["name"]
            behavior = report_data.get('behavior', {})
            summary = behavior.get('summary', {})
            regkey_opened = summary.get('regkey_opened', [])
            total_regkey_opened = len(regkey_opened)
    except Exception as e:
        print(f"Error processing {report_path}: {e}")
    return total_regkey_opened, regkey_opened, target_filename

def traverse_directory(directory_path):
    total_regkey_opened_overall = 0
    for root, dirs, files in os.walk(directory_path):
        for file in files:
            if file == 'report.json':
                report_path = os.path.join(root, file)
                total_regkey_opened, regkey_opened, target_filename = extract_regkey_opened(report_path)
                if regkey_opened:
                    total_regkey_opened_overall += total_regkey_opened
                    print(f"\nRegKey Opeaned by {target_filename} at {report_path}:")
                    for file_name in regkey_opened:
                        print(file_name)
                else:
                    print(f"\nNo RegKey Opeaned by {target_filename} at {report_path}")
    print(f"\nTotal number of RegKey Opeaned: {total_regkey_opened_overall}")

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print("Usage: python script.py <directory_path>")
        sys.exit(1)
    
    directory_path = sys.argv[1]
    traverse_directory(directory_path)
